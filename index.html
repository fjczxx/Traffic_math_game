<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TrafficMath â€” The Signal Keeper's Guild</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=IM+Fell+English:ital@0;1&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ROOT PALETTE â€” warm parchment world
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --parch-light: #f5e6c8;
  --parch:       #e8d5a3;
  --parch-dark:  #c9b06a;
  --parch-shadow:#a08840;
  --wood-light:  #8b6343;
  --wood:        #6b4423;
  --wood-dark:   #3d2010;
  --stone:       #8a7a6a;
  --stone-light: #b0a090;
  --cobble:      #6a5d4e;
  --ink:         #2c1810;
  --ink-soft:    #4a3828;
  --ink-faded:   #7a6050;
  --signal-red:  #c0392b;
  --signal-amber:#d4820a;
  --signal-green:#2e7d32;
  --signal-glow-r: rgba(192,57,43,0.5);
  --signal-glow-a: rgba(212,130,10,0.5);
  --signal-glow-g: rgba(46,125,50,0.5);
  --leaf:        #5a7a3a;
  --moss:        #7a9a5a;
  --gold:        #c9900a;
  --gold-light:  #e8b830;
  --cream:       #faf3e0;
  --vellum:      #f0e0b8;
}

* { margin:0; padding:0; box-sizing:border-box; }

html, body {
  height: 100%; overflow: hidden;
}

body {
  background: var(--wood-dark);
  color: var(--ink);
  font-family: 'Crimson Text', Georgia, serif;
  height: 100vh;
  overflow: hidden;
}

/* Parchment texture overlay */
body::before {
  content:'';
  position: fixed; inset: 0;
  background:
    url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='300'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3CfeColorMatrix type='saturate' values='0'/%3E%3C/filter%3E%3Crect width='300' height='300' filter='url(%23n)' opacity='0.08'/%3E%3C/svg%3E");
  pointer-events: none; z-index: 0;
}

/* Wood plank background */
body::after {
  content:'';
  position: fixed; inset: 0;
  background:
    repeating-linear-gradient(
      175deg,
      transparent 0px, transparent 38px,
      rgba(0,0,0,0.07) 38px, rgba(0,0,0,0.07) 40px
    ),
    linear-gradient(135deg, #2a1208 0%, #3d1f0a 40%, #2a1208 100%);
  pointer-events: none; z-index: -1;
}

.screen { position: relative; z-index: 1; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• PARCHMENT PANEL BASE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.parch-panel {
  background:
    radial-gradient(ellipse at 20% 10%, rgba(255,250,220,0.6) 0%, transparent 60%),
    radial-gradient(ellipse at 80% 90%, rgba(180,140,60,0.3) 0%, transparent 50%),
    linear-gradient(160deg, var(--parch-light) 0%, var(--parch) 40%, #d4c080 100%);
  border: 3px solid var(--wood);
  border-radius: 4px;
  box-shadow:
    0 2px 0 var(--parch-shadow) inset,
    0 -2px 0 rgba(255,255,255,0.4) inset,
    4px 8px 24px rgba(0,0,0,0.5),
    0 0 0 1px var(--wood-dark);
  position: relative;
}
.parch-panel::before {
  content:'';
  position: absolute; inset: 3px;
  border: 1px solid rgba(160,136,64,0.4);
  border-radius: 2px;
  pointer-events: none;
}

/* Wood frame header */
.wood-header {
  background: linear-gradient(180deg, var(--wood-light) 0%, var(--wood) 50%, var(--wood-dark) 100%);
  border-bottom: 2px solid var(--wood-dark);
  padding: .6rem 1.2rem;
  display: flex; align-items: center; justify-content: space-between;
  border-radius: 2px 2px 0 0;
  box-shadow: 0 2px 6px rgba(0,0,0,0.3) inset, 0 1px 0 rgba(255,255,255,0.15) inset;
}
.wood-header::after {
  content:'';
  position: absolute; top: 0; left: 0; right: 0; height: 1px;
  background: rgba(255,255,255,0.2);
}

/* Brass nail decorations */
.nail {
  width: 10px; height: 10px; border-radius: 50%;
  background: radial-gradient(circle at 35% 35%, var(--gold-light), var(--gold), #8a6000);
  box-shadow: 0 1px 3px rgba(0,0,0,0.5), 0 0 0 1px rgba(0,0,0,0.3);
  display: inline-block; flex-shrink: 0;
}
.corner-nails {
  position: absolute; top: 8px; right: 8px;
  display: flex; gap: 5px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TITLE SCREEN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#screen-title {
  display: flex; flex-direction: column;
  align-items: center; justify-content: flex-start;
  height: 100vh; text-align: center;
  padding: 1rem 1rem 1rem;
  overflow-y: auto;
}

.title-scroll {
  background:
    radial-gradient(ellipse at 50% 0%, rgba(255,250,230,0.8) 0%, transparent 70%),
    linear-gradient(180deg, var(--cream) 0%, var(--parch) 30%, var(--vellum) 70%, var(--parch) 100%);
  border: none;
  max-width: 780px; width: 100%;
  padding: 0;
  border-radius: 6px;
  box-shadow: 6px 12px 40px rgba(0,0,0,0.6), 0 0 0 1px rgba(0,0,0,0.4);
  position: relative;
  animation: unfurl 0.8s cubic-bezier(0.22,1,0.36,1) both;
}
@keyframes unfurl {
  from { transform: scaleY(0.3) translateY(-40px); opacity: 0; }
  to   { transform: scaleY(1) translateY(0); opacity: 1; }
}

/* Scroll curl tops */
.scroll-top, .scroll-bottom {
  height: 28px;
  background: linear-gradient(180deg, var(--wood-light) 0%, var(--wood) 60%, #a0724a 100%);
  border-radius: 4px;
  box-shadow: 0 4px 8px rgba(0,0,0,0.4) inset, 0 2px 0 rgba(255,255,255,0.15) inset;
  display: flex; align-items: center; padding: 0 16px;
  gap: 8px;
}
.scroll-bottom { flex-direction: row-reverse; border-radius: 0 0 4px 4px; }
.scroll-top    { border-radius: 4px 4px 0 0; }
.scroll-rod {
  flex: 1; height: 4px; border-radius: 2px;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
}

.scroll-body { padding: 1rem 1.8rem; }

.guild-crest {
  font-size: 1.8rem; margin-bottom: .2rem;
  filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
  animation: sway 4s ease-in-out infinite;
}

.logo {
  font-family: 'Cinzel', serif;
  font-size: clamp(1.3rem, 3.5vw, 2.2rem);
  font-weight: 700;
  color: var(--wood-dark);
  letter-spacing: 3px;
  text-shadow: 0 1px 0 rgba(255,255,255,0.5), 0 2px 6px rgba(0,0,0,0.2);
  margin-bottom: .2rem;
}
.subtitle {
  font-family: 'IM Fell English', serif;
  font-style: italic;
  color: var(--ink-faded);
  font-size: .9rem;
  letter-spacing: 1px;
  margin-bottom: .6rem;
}
.divider {
  border: none; height: 2px;
  background: linear-gradient(90deg, transparent, var(--parch-dark), var(--gold), var(--parch-dark), transparent);
  margin: .5rem 0;
}

@keyframes sway { 0%,100%{transform:rotate(-3deg)} 50%{transform:rotate(3deg)} }

/* Level grid */
.section-label {
  font-family: 'Cinzel', serif;
  font-size: .68rem;
  letter-spacing: 3px;
  color: var(--ink-faded);
  text-transform: uppercase;
  margin-bottom: .4rem;
}

.level-grid {
  display: grid; grid-template-columns: repeat(3, 1fr);
  gap: .5rem; margin: .4rem 0;
}
.level-card {
  background: linear-gradient(160deg, rgba(255,255,255,0.5) 0%, rgba(200,175,100,0.2) 100%);
  border: 1px solid rgba(120,90,40,0.4);
  border-radius: 4px;
  padding: .65rem .8rem;
  cursor: pointer;
  transition: all .25s;
  text-align: left;
  position: relative;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1), 0 1px 0 rgba(255,255,255,0.5) inset;
}
.level-card:hover {
  background: linear-gradient(160deg, rgba(255,255,255,0.7) 0%, rgba(220,195,120,0.4) 100%);
  border-color: var(--gold);
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(0,0,0,0.2), 0 1px 0 rgba(255,255,255,0.5) inset;
}
.level-card.locked { opacity: .35; cursor: not-allowed; pointer-events: none; }
.level-num {
  font-family: 'Cinzel', serif;
  font-size: .58rem; color: var(--gold);
  letter-spacing: 2px; margin-bottom: .2rem;
  text-transform: uppercase;
}
.level-card h3 {
  font-family: 'Cinzel', serif;
  font-size: .78rem; font-weight: 600;
  color: var(--ink); margin-bottom: .15rem;
}
.level-card p { font-size: .72rem; color: var(--ink-soft); line-height: 1.35; }

.tag {
  position: absolute; top: .7rem; right: .7rem;
  font-family: 'IM Fell English', serif;
  font-size: .65rem; font-style: italic;
  padding: 1px 7px; border-radius: 10px;
}
.tag-easy  { background: rgba(90,122,58,0.15);  color: var(--leaf);    border: 1px solid rgba(90,122,58,0.3);  }
.tag-mid   { background: rgba(201,144,10,0.15); color: var(--gold);    border: 1px solid rgba(201,144,10,0.3); }
.tag-hard  { background: rgba(192,57,43,0.12);  color: var(--signal-red); border: 1px solid rgba(192,57,43,0.25); }
.tag-elite { background: rgba(61,32,16,0.15);   color: var(--wood);    border: 1px solid rgba(61,32,16,0.3);   }

/* Intersection picker */
.intersection-grid {
  display: grid; grid-template-columns: repeat(3, 1fr);
  gap: .5rem; margin: .5rem 0;
}
.int-card {
  background: linear-gradient(160deg, rgba(255,255,255,0.4) 0%, rgba(200,175,100,0.15) 100%);
  border: 1px solid rgba(120,90,40,0.35);
  border-radius: 4px;
  padding: .5rem .4rem;
  cursor: pointer; transition: all .2s; text-align: center;
  box-shadow: 0 1px 4px rgba(0,0,0,0.1), 0 1px 0 rgba(255,255,255,0.5) inset;
}
.int-card:hover, .int-card.selected {
  border-color: var(--gold);
  background: linear-gradient(160deg, rgba(255,255,255,0.6) 0%, rgba(220,195,120,0.35) 100%);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}
.int-card svg { margin-bottom: .2rem; }
.int-card span {
  font-family: 'IM Fell English', serif;
  font-size: .75rem; font-style: italic;
  color: var(--ink-soft);
}

/* Buttons */
.btn {
  font-family: 'Cinzel', serif;
  font-size: .78rem; letter-spacing: 2px;
  text-transform: uppercase;
  padding: .7rem 1.8rem;
  border-radius: 3px;
  cursor: pointer; transition: all .2s;
}
.btn-primary {
  background: linear-gradient(180deg, var(--wood-light) 0%, var(--wood) 50%, var(--wood-dark) 100%);
  color: var(--parch-light);
  border: 1px solid var(--wood-dark);
  box-shadow: 0 3px 8px rgba(0,0,0,0.4), 0 1px 0 rgba(255,255,255,0.15) inset;
  text-shadow: 0 1px 2px rgba(0,0,0,0.5);
}
.btn-primary:hover {
  background: linear-gradient(180deg, #a07050 0%, var(--wood-light) 50%, var(--wood) 100%);
  transform: translateY(-1px);
  box-shadow: 0 5px 14px rgba(0,0,0,0.4), 0 1px 0 rgba(255,255,255,0.2) inset;
}
.btn-back {
  background: transparent;
  color: var(--ink-faded);
  border: 1px solid rgba(120,90,40,0.4);
  font-size: .7rem; padding: .4rem .9rem;
  box-shadow: none;
}
.btn-back:hover { color: var(--ink); border-color: var(--wood); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• GAME SCREEN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#screen-game {
  padding: .5rem;
  height: 100vh;
  overflow: hidden;
  flex-direction: column;
}

/* Top bar â€” wood plank */
.game-header {
  background: linear-gradient(180deg, var(--wood-light) 0%, var(--wood) 60%, #4a2a10 100%);
  border-radius: 4px;
  border: 1px solid var(--wood-dark);
  padding: .35rem .9rem;
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: .45rem; flex-wrap: wrap; gap: .3rem; flex-shrink: 0;
  box-shadow: 0 3px 12px rgba(0,0,0,0.5), 0 1px 0 rgba(255,255,255,0.12) inset;
}
.game-title {
  font-family: 'Cinzel', serif;
  font-size: .82rem; color: var(--parch-light);
  letter-spacing: 1px;
  text-shadow: 0 1px 3px rgba(0,0,0,0.6);
}
.diff-badge {
  font-family: 'IM Fell English', serif;
  font-style: italic;
  font-size: .7rem; padding: 1px 8px;
  border-radius: 10px; margin-left: .5rem;
}
.diff-1 { background: rgba(90,122,58,.25); color: #8aba58; border:1px solid rgba(90,122,58,.4); }
.diff-2 { background: rgba(201,144,10,.2); color: var(--gold-light); border:1px solid rgba(201,144,10,.35); }
.diff-3 { background: rgba(192,57,43,.2);  color: #e05a4a; border:1px solid rgba(192,57,43,.3); }
.diff-4 { background: rgba(61,32,16,.3);   color: var(--parch); border:1px solid rgba(160,114,64,.4); }

.stats { display: flex; gap: 1rem; }
.stat { text-align: center; }
.stat-val {
  font-family: 'Cinzel', serif;
  font-size: .95rem; font-weight: 700;
  text-shadow: 0 1px 4px rgba(0,0,0,0.5);
}
.stat-lbl {
  font-family: 'IM Fell English', serif;
  font-style: italic;
  font-size: .55rem; color: rgba(245,230,200,0.6);
  letter-spacing: 1px;
}
.score-val { color: var(--gold-light); }
.time-val  { color: #f08080; }
.flow-val  { color: #90e090; }

/* Main layout â€” flex row so left col is auto-width from its square canvas */
.game-layout {
  display: flex;
  flex-direction: row;
  gap: .5rem;
  flex: 1;
  min-height: 0;
  align-items: flex-start;
}

/* Canvas container â€” shrinks to square canvas size */
.intersection-container {
  flex: 0 0 auto;
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  min-height: 0;
}

/* Canvas frame size is set entirely by JS to be a perfect square */
.canvas-frame {
  position: relative;
  background: linear-gradient(180deg, var(--wood) 0%, var(--wood-dark) 100%);
  border: 3px solid var(--wood-dark);
  border-radius: 4px;
  padding: 6px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.6), 0 1px 0 rgba(255,255,255,0.1) inset;
  flex-shrink: 0;
  overflow: hidden;
}
.canvas-frame::before {
  content: '';
  position: absolute; inset: 3px;
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: 2px;
  pointer-events: none; z-index: 10;
}

/* Canvas display size is set via JS â€” no CSS stretching */
canvas#intersection-canvas {
  border-radius: 2px;
  display: block;
}
#math-overlay-canvas {
  border-radius: 2px;
  position: absolute;
  top: 6px; left: 6px;
  pointer-events: none;
}

/* Right panel fills remaining space */
.control-panel {
  flex: 1 1 0;
  min-width: 260px;
  max-width: 320px;
}

/* Arrival badges */
.arrival-display {
  display: grid; grid-template-columns: 1fr 1fr;
  gap: .25rem; margin-top: .3rem; flex-shrink: 0;
  /* width is set by JS to match canvas */
}
.arr-badge {
  background: linear-gradient(135deg, rgba(245,230,200,0.92), rgba(220,195,130,0.85));
  border: 1px solid rgba(120,90,40,0.45);
  border-radius: 3px;
  padding: .18rem .5rem;
  font-family: 'IM Fell English', serif;
  font-size: .68rem;
  display: flex; justify-content: space-between; align-items: center;
  box-shadow: 0 1px 3px rgba(0,0,0,0.15), 0 1px 0 rgba(255,255,255,0.5) inset;
}
.arr-badge .dir { color: var(--ink-faded); font-style: italic; }
.arr-badge .rate { color: var(--wood-dark); font-weight: 600; }
.arr-badge .rate.hot { color: var(--signal-red); animation: flicker 1s ease-in-out infinite; }
@keyframes flicker { 0%,100%{opacity:1} 50%{opacity:.5} }

/* Flow meter */
.flow-meter { width: 100%; margin-top: .3rem; flex-shrink: 0; }
.flow-label {
  font-family: 'IM Fell English', serif;
  font-style: italic;
  font-size: .68rem; color: var(--ink-faded);
  margin-bottom: .2rem;
  display: flex; justify-content: space-between;
}
.flow-bar-bg {
  background: rgba(0,0,0,0.2);
  border-radius: 2px; height: 8px;
  overflow: hidden;
  border: 1px solid rgba(120,90,40,0.5);
  box-shadow: inset 0 1px 3px rgba(0,0,0,0.3);
}
.flow-bar {
  height: 100%; border-radius: 2px;
  transition: width .9s ease, background .6s;
  box-shadow: 0 0 6px currentColor;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CONTROL PANEL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.control-panel {
  flex: 1 1 0;
  min-width: 260px;
  max-width: 320px;
  border-radius: 4px;
  overflow: hidden;
  box-shadow: 4px 8px 24px rgba(0,0,0,0.5);
  display: flex; flex-direction: column;
  border: 2px solid var(--wood-dark);
  align-self: stretch;
}
.control-panel-body {
  background:
    radial-gradient(ellipse at 20% 10%, rgba(255,250,220,0.55) 0%, transparent 60%),
    linear-gradient(170deg, var(--parch-light) 0%, var(--parch) 50%, #d0be88 100%);
  padding: .6rem .7rem;
  overflow-y: auto; flex: 1;
  min-height: 0;
}
.control-panel-body::-webkit-scrollbar { width: 4px; }
.control-panel-body::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
.control-panel-body::-webkit-scrollbar-thumb { background: var(--parch-dark); border-radius: 2px; }

.panel-title {
  font-family: 'Cinzel', serif;
  font-size: .65rem; color: var(--ink-faded);
  letter-spacing: 3px; text-transform: uppercase;
  text-align: center; margin-bottom: .6rem;
  display: flex; align-items: center; gap: .5rem;
  justify-content: center;
}
.panel-title::before, .panel-title::after {
  content:''; flex:1; height:1px;
  background: linear-gradient(90deg, transparent, var(--parch-dark), transparent);
}

/* Signal rows */
.signal-row {
  background: rgba(255,255,255,0.35);
  border: 1px solid rgba(120,90,40,0.3);
  border-radius: 3px;
  padding: .45rem .6rem; margin-bottom: .45rem;
  box-shadow: 0 1px 0 rgba(255,255,255,0.6) inset;
}
.signal-row h4 {
  font-family: 'Cinzel', serif;
  font-size: .65rem; font-weight: 600;
  color: var(--ink-soft);
  margin-bottom: .35rem;
  display: flex; align-items: center; gap: .4rem;
}
.dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; box-shadow: 0 0 4px currentColor; }

.phase-inputs { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: .3rem; }
.phase-col { text-align: center; }
.phase-col label {
  font-family: 'IM Fell English', serif;
  font-style: italic;
  font-size: .6rem; display: block; margin-bottom: .18rem;
}
.lbl-red    { color: var(--signal-red); }
.lbl-yellow { color: var(--signal-amber); }
.lbl-green  { color: var(--signal-green); }
.phase-col input[type=number] {
  width: 100%;
  background: rgba(255,255,255,0.7);
  border: 1px solid rgba(120,90,40,0.4);
  color: var(--ink);
  border-radius: 2px; padding: .25rem;
  text-align: center;
  font-family: 'Crimson Text', serif;
  font-size: .9rem; font-weight: 600;
  box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
}
.phase-col input:focus { outline: none; border-color: var(--gold); box-shadow: 0 0 0 2px rgba(201,144,10,0.2), inset 0 1px 3px rgba(0,0,0,0.1); }

/* Yield sliders */
.yield-row {
  background: rgba(255,255,255,0.3);
  border: 1px solid rgba(120,90,40,0.3);
  border-radius: 3px;
  padding: .45rem .6rem; margin-bottom: .45rem;
  box-shadow: 0 1px 0 rgba(255,255,255,0.6) inset;
}
.yield-row h4 {
  font-family: 'Cinzel', serif;
  font-size: .65rem; color: var(--ink-soft);
  margin-bottom: .3rem;
}
.yield-row p { font-family:'IM Fell English',serif; font-style:italic; font-size:.65rem; color:var(--ink-faded); margin-bottom:.35rem; }
.yield-row input[type=range] {
  width: 100%; accent-color: var(--wood);
  margin-bottom: .2rem;
}
.yield-val {
  font-family: 'Cinzel', serif;
  color: var(--wood); font-size: .82rem; text-align: center;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MATH SCROLL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.math-scroll {
  margin-top: .5rem;
  position: relative;
}
.scroll-header {
  background: linear-gradient(180deg, var(--wood-light) 0%, var(--wood) 100%);
  border: 1px solid var(--wood-dark);
  border-radius: 3px 3px 0 0;
  padding: .3rem .7rem;
  display: flex; justify-content: space-between; align-items: center;
  box-shadow: 0 1px 0 rgba(255,255,255,0.12) inset;
}
.scroll-header-title {
  font-family: 'Cinzel', serif;
  font-size: .62rem; color: var(--parch-light);
  letter-spacing: 2px; text-transform: uppercase;
  text-shadow: 0 1px 2px rgba(0,0,0,0.5);
}
.math-topic-badge {
  font-family: 'IM Fell English', serif;
  font-style: italic;
  font-size: .6rem;
  background: rgba(245,230,200,0.2);
  color: var(--parch);
  border: 1px solid rgba(245,230,200,0.3);
  padding: 1px 7px; border-radius: 10px;
}
.scroll-content {
  background:
    linear-gradient(180deg, rgba(250,243,224,0.98) 0%, rgba(240,228,184,0.97) 100%);
  border: 1px solid rgba(120,90,40,0.4);
  border-top: none;
  border-radius: 0 0 3px 3px;
  padding: .55rem .65rem;
  box-shadow: inset 0 2px 8px rgba(0,0,0,0.08);
}

/* Steps */
.steps-bar { display: flex; gap: .35rem; margin-bottom: .5rem; align-items: center; }
.step-pip {
  width: 8px; height: 8px; border-radius: 50%;
  background: rgba(120,90,40,0.2);
  border: 1px solid rgba(120,90,40,0.3);
  transition: all .35s;
}
.step-pip.done { background: var(--signal-green); border-color: var(--signal-green); box-shadow: 0 0 6px var(--signal-glow-g); }
.step-pip.current { background: var(--gold); border-color: var(--gold); box-shadow: 0 0 6px var(--signal-glow-a); }

.math-question {
  font-family: 'Crimson Text', serif;
  font-size: .82rem; line-height: 1.6;
  color: var(--ink); margin-bottom: .45rem;
  border-left: 2px solid var(--parch-dark);
  padding-left: .5rem;
}
.math-question .hl  { color: var(--wood); font-weight: 600; }
.math-question .hlg { color: var(--signal-green); font-weight: 600; }
.math-question .hlr { color: var(--signal-red); font-weight: 600; }
.math-question .hlp { color: #7a3a7a; font-weight: 600; }

.math-hint {
  font-family: 'IM Fell English', serif;
  font-style: italic;
  font-size: .73rem; color: var(--ink-faded);
  margin-bottom: .5rem;
  padding: .28rem .5rem;
  background: rgba(200,175,100,0.15);
  border-radius: 2px;
  border-left: 2px solid var(--parch-dark);
}

.math-input-row { display: flex; gap: .4rem; }
.math-input-row input {
  flex: 1;
  background: rgba(255,255,255,0.8);
  border: 1px solid rgba(120,90,40,0.4);
  color: var(--ink); border-radius: 2px;
  padding: .35rem;
  font-family: 'Crimson Text', serif;
  font-size: .95rem; font-weight: 600;
  text-align: center;
  box-shadow: inset 0 1px 4px rgba(0,0,0,0.1);
}
.math-input-row input:focus { outline: none; border-color: var(--gold); box-shadow: 0 0 0 2px rgba(201,144,10,0.2), inset 0 1px 4px rgba(0,0,0,0.1); }

.btn-check {
  background: linear-gradient(180deg, var(--wood-light) 0%, var(--wood) 100%);
  color: var(--parch-light);
  font-family: 'Cinzel', serif;
  font-size: .6rem; letter-spacing: 1px;
  border: 1px solid var(--wood-dark);
  border-radius: 2px; padding: .35rem .6rem;
  cursor: pointer; transition: all .2s;
  box-shadow: 0 2px 6px rgba(0,0,0,0.3), 0 1px 0 rgba(255,255,255,0.12) inset;
  text-shadow: 0 1px 2px rgba(0,0,0,0.4);
  text-transform: uppercase;
}
.btn-check:hover { filter: brightness(1.1); transform: translateY(-1px); }

.feedback {
  font-family: 'IM Fell English', serif;
  font-style: italic;
  font-size: .75rem;
  margin-top: .35rem; padding: .28rem .5rem;
  border-radius: 2px; display: none;
  line-height: 1.35;
}
.feedback.correct {
  background: rgba(46,125,50,0.1); color: var(--signal-green);
  border: 1px solid rgba(46,125,50,0.3);
  border-left: 3px solid var(--signal-green);
}
.feedback.wrong {
  background: rgba(192,57,43,0.1); color: var(--signal-red);
  border: 1px solid rgba(192,57,43,0.25);
  border-left: 3px solid var(--signal-red);
}

.overlay-toggle-label {
  display: flex; align-items: center; gap: .4rem;
  font-family: 'IM Fell English', serif; font-style: italic;
  font-size: .68rem; color: var(--ink-faded);
  cursor: pointer; margin-top: .4rem;
}

.btn-apply {
  width: 100%; margin-top: .5rem;
  background: linear-gradient(180deg, var(--wood-light) 0%, var(--wood) 50%, var(--wood-dark) 100%);
  color: var(--parch-light);
  border: 1px solid var(--wood-dark);
  border-radius: 3px; padding: .5rem;
  font-family: 'Cinzel', serif; font-size: .65rem;
  letter-spacing: 2px; cursor: pointer;
  transition: all .2s;
  box-shadow: 0 3px 10px rgba(0,0,0,0.4), 0 1px 0 rgba(255,255,255,0.12) inset;
  text-shadow: 0 1px 2px rgba(0,0,0,0.5);
  text-transform: uppercase;
}
.btn-apply:hover { filter: brightness(1.1); transform: translateY(-1px); box-shadow: 0 5px 16px rgba(0,0,0,0.4); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• COMPLETION OVERLAY â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.overlay {
  position: fixed; inset: 0;
  background: rgba(30,15,5,0.85);
  display: none; align-items: center; justify-content: center;
  z-index: 100;
  backdrop-filter: blur(3px);
}
.overlay.show { display: flex; animation: fadeIn .4s ease; }
@keyframes fadeIn { from{opacity:0} to{opacity:1} }

.overlay-scroll {
  max-width: 460px; width: 90%;
  animation: popIn .4s cubic-bezier(0.34,1.56,0.64,1);
}
@keyframes popIn { from{transform:scale(0.8);opacity:0} to{transform:scale(1);opacity:1} }

.overlay-body {
  background:
    radial-gradient(ellipse at 50% 10%, rgba(255,255,230,0.7) 0%, transparent 60%),
    linear-gradient(170deg, var(--cream) 0%, var(--parch) 60%, #d0be88 100%);
  border: 2px solid var(--wood);
  border-radius: 0;
  padding: 2rem; text-align: center;
  box-shadow: 6px 12px 40px rgba(0,0,0,0.7);
}
.overlay-body h2 {
  font-family: 'Cinzel', serif;
  font-size: 1.5rem; font-weight: 700;
  color: var(--wood-dark); margin-bottom: .7rem;
  text-shadow: 0 1px 0 rgba(255,255,255,0.5);
}
.overlay-body p {
  font-family: 'Crimson Text', serif;
  color: var(--ink-soft);
  margin-bottom: 1.5rem; line-height: 1.7;
  font-size: 1rem;
}
.stars { font-size: 2rem; margin-bottom: .8rem; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3)); }

@media (max-width: 860px) {
  .game-layout { grid-template-columns: 1fr; overflow-y: auto; }
  .level-grid { grid-template-columns: repeat(2,1fr); }
  #screen-game { overflow-y: auto; height: auto; min-height: 100vh; }
}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• TITLE SCREEN â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-title" class="screen">
  <div class="title-scroll">
    <div class="scroll-top">
      <div class="nail"></div><div class="scroll-rod"></div><div class="nail"></div>
    </div>
    <div class="scroll-body">
      <div class="guild-crest">ğŸ›ï¸</div>
      <div class="logo">The Signal Keeper's Guild</div>
      <div class="subtitle">~ TrafficMath: An Academy of Flow & Form ~</div>
      <hr class="divider">
      <p style="font-family:'IM Fell English',serif;font-style:italic;color:var(--ink-soft);font-size:.95rem;max-width:480px;margin:0 auto .8rem;line-height:1.7;">
        Master the ancient art of signal timing through the language of mathematics â€” from the humble linear equation to the mysteries of geometric algebra.
      </p>
      <hr class="divider">

      <div class="section-label">Choose thy chapter of study</div>
      <div class="level-grid">
        <div class="level-card" onclick="selectLevel(0)">
          <div class="level-num">Chapter I</div>
          <h3>The Single Crossing</h3>
          <p>Linear equations govern the rhythm of one intersection.</p>
          <span class="tag tag-easy">Apprentice</span>
        </div>
        <div class="level-card" onclick="selectLevel(1)">
          <div class="level-num">Chapter II</div>
          <h3>The Paired Gates</h3>
          <p>Two signals, two equations â€” a system must be solved.</p>
          <span class="tag tag-mid">Journeyman</span>
        </div>
        <div class="level-card" onclick="selectLevel(2)">
          <div class="level-num">Chapter III</div>
          <h3>The Signal Grid</h3>
          <p>Matrix arithmetic synchronises four corners of the realm.</p>
          <span class="tag tag-mid">Journeyman</span>
        </div>
        <div class="level-card" onclick="selectLevel(3)">
          <div class="level-num">Chapter IV</div>
          <h3>The Vector Tide</h3>
          <p>Traffic flows as vectors; dot products reveal the path.</p>
          <span class="tag tag-hard">Adept</span>
        </div>
        <div class="level-card" onclick="selectLevel(4)">
          <div class="level-num">Chapter V</div>
          <h3>The Eigenflow</h3>
          <p>Eigenvalues illuminate the long-run steady state.</p>
          <span class="tag tag-hard">Adept</span>
        </div>
        <div class="level-card" onclick="selectLevel(5)">
          <div class="level-num">Chapter VI</div>
          <h3>The Rotor's Circle</h3>
          <p>Geometric algebra governs the great roundabout.</p>
          <span class="tag tag-elite">Master</span>
        </div>
      </div>

      <!-- Intersection picker -->
      <div id="intersection-picker" style="display:none;">
        <hr class="divider" style="margin-top:.5rem;">
        <div class="section-label" style="margin-top:.8rem;">Choose thy crossroads</div>
        <div class="intersection-grid">
          <div class="int-card selected" onclick="selectInt(this,'4way')" id="int-4way">
            <svg width="56" height="56" viewBox="0 0 56 56">
              <rect x="22" y="0" width="12" height="56" fill="#8a7a6a"/>
              <rect x="0" y="22" width="56" height="12" fill="#8a7a6a"/>
              <rect x="22" y="22" width="12" height="12" fill="#6a5d4e"/>
              <!-- Cobble dots -->
              <circle cx="11" cy="11" r="2" fill="rgba(0,0,0,0.2)"/>
              <circle cx="45" cy="11" r="2" fill="rgba(0,0,0,0.2)"/>
              <circle cx="11" cy="45" r="2" fill="rgba(0,0,0,0.2)"/>
              <circle cx="45" cy="45" r="2" fill="rgba(0,0,0,0.2)"/>
            </svg><br>
            <span>Four-Way Cross</span>
          </div>
          <div class="int-card" onclick="selectInt(this,'T')">
            <svg width="56" height="56" viewBox="0 0 56 56">
              <rect x="22" y="0" width="12" height="34" fill="#8a7a6a"/>
              <rect x="0" y="22" width="56" height="12" fill="#8a7a6a"/>
              <rect x="22" y="22" width="12" height="12" fill="#6a5d4e"/>
              <circle cx="11" cy="11" r="2" fill="rgba(0,0,0,0.2)"/>
              <circle cx="45" cy="11" r="2" fill="rgba(0,0,0,0.2)"/>
            </svg><br>
            <span>T-Junction</span>
          </div>
          <div class="int-card" onclick="selectInt(this,'roundabout')">
            <svg width="56" height="56" viewBox="0 0 56 56">
              <circle cx="28" cy="28" r="13" fill="none" stroke="#8a7a6a" stroke-width="9"/>
              <circle cx="28" cy="28" r="7" fill="#6a5d4e"/>
              <rect x="22" y="0" width="12" height="15" fill="#8a7a6a"/>
              <rect x="22" y="41" width="12" height="15" fill="#8a7a6a"/>
              <rect x="0" y="22" width="15" height="12" fill="#8a7a6a"/>
              <rect x="41" y="22" width="15" height="12" fill="#8a7a6a"/>
            </svg><br>
            <span>Roundabout</span>
          </div>
        </div>
        <div style="display:flex;gap:.7rem;justify-content:center;margin-top:.8rem;flex-wrap:wrap;">
          <button class="btn btn-primary" onclick="startGame()">âœ¦ Begin the Mission âœ¦</button>
          <button class="btn btn-back" onclick="document.getElementById('intersection-picker').style.display='none'">â† Back</button>
        </div>
      </div>

    </div>
    <div class="scroll-bottom">
      <div class="nail"></div><div class="scroll-rod"></div><div class="nail"></div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• GAME SCREEN â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-game" class="screen" style="display:none;flex-direction:column;height:100vh;padding:.5rem;overflow:hidden;">

  <!-- Wood-plank header -->
  <div class="game-header">
    <div>
      <div class="game-title" id="game-title">Chapter I â€” The Single Crossing</div>
      <span id="diff-label" class="diff-badge diff-1">Apprentice</span>
    </div>
    <div class="stats">
      <div class="stat"><div class="stat-val score-val" id="stat-score">0</div><div class="stat-lbl">Coin</div></div>
      <div class="stat"><div class="stat-val flow-val" id="stat-flow">30%</div><div class="stat-lbl">Flow</div></div>
      <div class="stat"><div class="stat-val time-val" id="stat-timer">120</div><div class="stat-lbl">Turns</div></div>
      <div class="stat"><div class="stat-val" id="stat-math" style="color:var(--gold-light)">0</div><div class="stat-lbl">Solved</div></div>
    </div>
    <button class="btn btn-back" onclick="goHome()" style="color:var(--parch-light);border-color:rgba(245,230,200,0.3);">â¬¡ Guild Hall</button>
  </div>

  <div class="game-layout">

    <!-- Canvas + meters -->
    <div class="intersection-container">
      <div class="canvas-frame" id="canvas-frame" style="position:relative;">
        <canvas id="intersection-canvas"></canvas>
        <canvas id="math-overlay-canvas" style="position:absolute;top:0;left:0;pointer-events:none;"></canvas>
      </div>

      <div class="arrival-display" id="arrival-display">
        <div class="arr-badge"><span class="dir">â†‘ North</span><span class="rate" id="arr-N">8/min</span></div>
        <div class="arr-badge"><span class="dir">â†“ South</span><span class="rate" id="arr-S">6/min</span></div>
        <div class="arr-badge"><span class="dir">â† West</span><span class="rate" id="arr-W">5/min</span></div>
        <div class="arr-badge"><span class="dir">â†’ East</span><span class="rate" id="arr-E">7/min</span></div>
      </div>

      <div class="flow-meter">
        <div class="flow-label">
          <span style="font-style:italic;">Traffic Flow Efficiency</span>
          <span id="target-label">Target: 75%</span>
        </div>
        <div class="flow-bar-bg"><div class="flow-bar" id="flow-bar" style="width:30%;background:var(--signal-red)"></div></div>
      </div>
    </div>

    <!-- Right control panel -->
    <div class="control-panel parch-panel" style="padding:0;">
      <div class="wood-header">
        <span style="font-family:'Cinzel',serif;font-size:.72rem;color:var(--parch-light);letter-spacing:2px;text-transform:uppercase;text-shadow:0 1px 2px rgba(0,0,0,0.5);">
          âš™ Signal Controls
        </span>
        <div style="display:flex;gap:4px;"><div class="nail"></div><div class="nail"></div></div>
      </div>
      <div class="control-panel-body">

        <div id="standard-controls">
          <div class="signal-row">
            <h4><span class="dot" style="background:var(--signal-green);color:var(--signal-green)"></span> Gate A &mdash; â†‘â†“ North / South</h4>
            <div class="phase-inputs">
              <div class="phase-col"><label class="lbl-red">Red (s)</label><input type="number" id="a-red" value="30" min="5" max="90"></div>
              <div class="phase-col"><label class="lbl-yellow">Amber (s)</label><input type="number" id="a-yellow" value="5" min="3" max="15"></div>
              <div class="phase-col"><label class="lbl-green">Green (s)</label><input type="number" id="a-green" value="25" min="5" max="90"></div>
            </div>
          </div>
          <div class="signal-row" id="signal-b-row">
            <h4><span class="dot" style="background:var(--signal-amber);color:var(--signal-amber)"></span> Gate B &mdash; â†â†’ East / West</h4>
            <div class="phase-inputs">
              <div class="phase-col"><label class="lbl-red">Red (s)</label><input type="number" id="b-red" value="25" min="5" max="90"></div>
              <div class="phase-col"><label class="lbl-yellow">Amber (s)</label><input type="number" id="b-yellow" value="5" min="3" max="15"></div>
              <div class="phase-col"><label class="lbl-green">Green (s)</label><input type="number" id="b-green" value="30" min="5" max="90"></div>
            </div>
          </div>
        </div>

        <div id="roundabout-controls" style="display:none;">
          <div class="yield-row">
            <h4>ğŸ”„ Yield Arc Angle</h4>
            <p>Set the arc (in degrees) where carts give way to the circle. The rotor angle Î¸ governs all.</p>
            <input type="range" id="yield-angle" min="10" max="170" value="60" oninput="updateYieldDisplay()">
            <div class="yield-val" id="yield-val">Î¸ = 60Â°</div>
          </div>
          <div class="yield-row">
            <h4>ğŸ”„ Rotor Speed</h4>
            <input type="range" id="rotor-speed" min="1" max="10" value="4" oninput="updateYieldDisplay()">
            <div class="yield-val" id="rotor-val">Ï‰ = 4 rad/s</div>
          </div>
        </div>

        <!-- Math scroll -->
        <div class="math-scroll">
          <div class="scroll-header">
            <span class="scroll-header-title">ğŸ“œ The Scholar's Challenge</span>
            <span class="math-topic-badge" id="math-topic">Linear</span>
          </div>
          <div class="scroll-content">
            <div class="steps-bar" id="steps-bar"></div>
            <div class="math-question" id="math-q">Loading challengeâ€¦</div>
            <div class="math-hint" id="math-hint"></div>
            <div class="math-input-row">
              <input type="number" id="math-answer" placeholder="?" step="0.1"/>
              <button class="btn-check" onclick="checkMath()">Submit</button>
            </div>
            <div class="feedback" id="feedback"></div>
          </div>
        </div>

        <label class="overlay-toggle-label">
          <input type="checkbox" id="overlay-toggle" checked onchange="toggleOverlay()">
          Show equation overlay on the map
        </label>

        <button class="btn-apply" onclick="applyTiming()">âœ¦ Apply Timing & Observe âœ¦</button>

      </div><!-- /control-panel-body -->
    </div><!-- /control-panel -->

  </div><!-- /game-layout -->
</div><!-- /screen-game -->

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• COMPLETION OVERLAY â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="overlay" id="overlay-complete">
  <div class="overlay-scroll">
    <div class="scroll-top"><div class="nail"></div><div class="scroll-rod"></div><div class="nail"></div></div>
    <div class="overlay-body">
      <div class="stars" id="overlay-stars">â­â­â­</div>
      <h2 id="overlay-title">The Flow is Restored!</h2>
      <p id="overlay-msg"></p>
      <div style="display:flex;gap:.7rem;justify-content:center;flex-wrap:wrap;">
        <button class="btn btn-primary" onclick="nextLevel()">âœ¦ Next Chapter âœ¦</button>
        <button class="btn btn-back" onclick="goHome()">Guild Hall</button>
      </div>
    </div>
    <div class="scroll-bottom"><div class="nail"></div><div class="scroll-rod"></div><div class="nail"></div></div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LEVEL DATA (unchanged logic from v2)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const LEVELS=[
  {title:'Chapter I â€” The Single Crossing',diff:1,diffLabel:'Apprentice',diffClass:'diff-1',intType:'4way',targetFlow:75,timer:90,showB:false,topic:'Linear',
   arrivalBase:{N:8,S:6,E:7,W:5},difficultyScale:[1,1.3,1.7],
   mathChallenges:[
    {q:`Cars arrive N+S at combined <span class="hl">20/min</span>, clearance <span class="hl">15 cars/min</span>.<br>Max wait = <span class="hl">60 s</span>.<br>Minimum green time: <span class="hl">g â‰¥ (20/15) Ã— 60 = ?</span> seconds`,
     hint:'Divide arrival rate by clearance rate, multiply by max wait.',answer:80,tolerance:2,
     overlay:{type:'linear',eq:'g = (Î»/Î¼)Â·W',vars:{Î»:20,Î¼:15,W:60}}},
    {q:`Cycle = red + yellow + green = <span class="hl">60 s</span>.<br>red = <span class="hl">30 s</span>, yellow = <span class="hl">5 s</span>.<br>Solve: green = C âˆ’ r âˆ’ y = <span class="hlg">?</span>`,
     hint:'Simple subtraction: 60 âˆ’ 30 âˆ’ 5',answer:25,tolerance:1,
     overlay:{type:'linear',eq:'g = C âˆ’ r âˆ’ y',vars:{C:60,r:30,y:5}}}
   ]},
  {title:'Chapter II â€” The Paired Gates',diff:2,diffLabel:'Journeyman',diffClass:'diff-2',intType:'4way',targetFlow:78,timer:100,showB:true,topic:'Systems',
   arrivalBase:{N:12,S:9,E:10,W:8},difficultyScale:[1,1.4,1.8],
   mathChallenges:[
    {q:`Green budget shared between A and B.<br><span class="hl">x + y = 50</span> &nbsp;(total green budget)<br><span class="hl">2x âˆ’ y = 10</span> &nbsp;(demand balance)<br>Solve for <span class="hlg">x</span> (A-green, seconds):`,
     hint:'Add both equations: 3x = 60, so x = ?',answer:20,tolerance:1,
     overlay:{type:'system',eqs:['x + y = 50','2x âˆ’ y = 10'],highlight:'x'}},
    {q:`Signal offset: vehicle speed = <span class="hl">13.9 m/s</span>.<br>Distance between signals = <span class="hl">280 m</span>.<br>Offset: Î”t = 280 / 13.9 = <span class="hlg">?</span> s`,
     hint:'Simple division: 280 Ã· 13.9',answer:20.1,tolerance:0.3,
     overlay:{type:'linear',eq:'Î”t = d / v',vars:{d:280,v:13.9}}}
   ]},
  {title:'Chapter III â€” The Signal Grid',diff:2,diffLabel:'Journeyman',diffClass:'diff-2',intType:'4way',targetFlow:80,timer:110,showB:true,topic:'Matrix',
   arrivalBase:{N:14,S:11,E:13,W:10},difficultyScale:[1,1.5,2],
   mathChallenges:[
    {q:`Offset matrix: <span class="hl">M = [[10, 5], [8, 12]]</span><br>Demand vector: <span class="hl">d = [2, 1]áµ€</span><br>First element of <span class="hlg">MÂ·d</span>:<br><span class="hl">10Ã—2 + 5Ã—1</span> = <span class="hlg">?</span>`,
     hint:'Row 1 dot d: 10Ã—2 = 20, plus 5Ã—1 = 5',answer:25,tolerance:1,
     overlay:{type:'matrix',M:[[10,5],[8,12]],d:[2,1],highlight:0}},
    {q:`Transition matrix: <span class="hl">T = [[0.7, 0.3], [0.4, 0.6]]</span><br>State: <span class="hl">s = [60, 40]áµ€</span><br>First element of <span class="hlg">TÂ·s</span>:<br><span class="hl">0.7Ã—60 + 0.3Ã—40</span> = <span class="hlg">?</span>`,
     hint:'0.7Ã—60 = 42, 0.3Ã—40 = 12, sum = ?',answer:54,tolerance:1,
     overlay:{type:'matrix',M:[[0.7,0.3],[0.4,0.6]],d:[60,40],highlight:0}}
   ]},
  {title:'Chapter IV â€” The Vector Tide',diff:3,diffLabel:'Adept',diffClass:'diff-3',intType:'4way',targetFlow:82,timer:110,showB:true,topic:'Vectors',
   arrivalBase:{N:16,S:13,E:15,W:12},difficultyScale:[1,1.6,2.2],
   mathChallenges:[
    {q:`Demand vector: <span class="hl">d = [3, 4]</span> (N/S, E/W).<br>Capacity vector: <span class="hl">c = [5, 5]</span>.<br><span class="hlg">Dot product dÂ·c</span>:<br><span class="hl">3Ã—5 + 4Ã—5</span> = <span class="hlg">?</span>`,
     hint:'Multiply element-by-element then add.',answer:35,tolerance:1,
     overlay:{type:'vector',v1:[3,4],v2:[5,5],op:'dot'}},
    {q:`Flow vectors: <span class="hl">a = [6, 0]</span>, <span class="hl">b = [0, 8]</span>.<br>Magnitude of combined flow <span class="hlg">|a + b|</span>:<br><span class="hl">âˆš(6Â² + 8Â²)</span> = <span class="hlg">?</span>`,
     hint:'Pythagoras: âˆš(36 + 64) = âˆš100',answer:10,tolerance:0.1,
     overlay:{type:'vector',v1:[6,0],v2:[0,8],op:'magnitude'}},
    {q:`Unit vector of flow <span class="hl">v = [9, 12]</span>.<br>|v| = 15.<br>x-component of <span class="hlg">vÌ‚ = v/|v|</span> = 9/15 = <span class="hlg">?</span>`,
     hint:'Simply divide 9 by 15.',answer:0.6,tolerance:0.02,
     overlay:{type:'vector',v1:[9,12],v2:null,op:'unit'}}
   ]},
  {title:'Chapter V â€” The Eigenflow',diff:3,diffLabel:'Adept',diffClass:'diff-3',intType:'4way',targetFlow:84,timer:120,showB:true,topic:'Eigenvalues',
   arrivalBase:{N:18,S:15,E:17,W:14},difficultyScale:[1,1.8,2.5],
   mathChallenges:[
    {q:`Transition matrix: <span class="hl">A = [[0.8, 0.2], [0.3, 0.7]]</span><br>For stochastic matrices, one eigenvalue is always:<br><span class="hlg">Î»â‚</span> = <span class="hlg">?</span>`,
     hint:'For column-stochastic matrices, Î»=1 is always an eigenvalue.',answer:1,tolerance:0.01,
     overlay:{type:'eigen',A:[[0.8,0.2],[0.3,0.7]],eigenvals:[1,0.5]}},
    {q:`Steady-state: <span class="hl">AÏ€ = Ï€</span>.<br>Solve <span class="hl">0.2Â·Ï€â‚‚ = 0.3Â·Ï€â‚</span> with <span class="hl">Ï€â‚+Ï€â‚‚ = 1</span>.<br>What is <span class="hlg">Ï€â‚</span>? (N/S green fraction)`,
     hint:'Substitute Ï€â‚‚ = 1âˆ’Ï€â‚ into the first equation.',answer:0.4,tolerance:0.02,
     overlay:{type:'eigen',A:[[0.8,0.2],[0.3,0.7]],eigenvals:[1,0.5],steadyState:[0.4,0.6]}}
   ]},
  {title:'Chapter VI â€” The Rotor\'s Circle',diff:4,diffLabel:'Master',diffClass:'diff-4',intType:'roundabout',targetFlow:85,timer:130,showB:false,topic:'Rotors',
   arrivalBase:{N:20,S:17,E:19,W:16},difficultyScale:[1,2,3],
   mathChallenges:[
    {q:`Rotor in GA: <span class="hl">R = cos(Î¸/2) + sin(Î¸/2)Â·eâ‚â‚‚</span><br>For yield angle <span class="hl">Î¸ = 60Â°</span>, compute <span class="hlg">cos(Î¸/2)</span>:<br>cos(30Â°) = <span class="hlg">?</span> (2 dp)`,
     hint:'cos(30Â°) = âˆš3/2 â‰ˆ 0.866',answer:0.87,tolerance:0.01,
     overlay:{type:'rotor',theta:60,op:'cos_half'}},
    {q:`Flow entering at <span class="hl">Î± = 45Â°</span>, rotor rotation <span class="hl">Î¸ = 90Â°</span>.<br>Exit angle = Î± + Î¸ = 135Â°.<br><span class="hlg">sin(135Â°)</span> = sin(45Â°)Â·cos(90Â°) + cos(45Â°)Â·sin(90Â°) = <span class="hlg">?</span>`,
     hint:'sin(90Â°)=1, cos(90Â°)=0, cos(45Â°)â‰ˆ0.707',answer:0.71,tolerance:0.02,
     overlay:{type:'rotor',theta:90,alpha:45,op:'sandwich'}},
    {q:`Roundabout capacity: <span class="hl">C = Ï‰Â·rÂ²Â·Ï€</span><br><span class="hl">Ï‰ = 4 rad/s</span>, <span class="hl">r = 15 m</span>.<br>C = 4 Ã— 225 Ã— Ï€ â‰ˆ <span class="hlg">?</span> (nearest 10)`,
     hint:'4 Ã— 225 = 900, multiply by Ï€ â‰ˆ 3.14159',answer:2830,tolerance:20,
     overlay:{type:'rotor',omega:4,r:15,op:'capacity'}}
   ]}
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• STATE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentLevel=0,currentInt='4way',score=0,flowPct=30;
let timer=90,timerInterval=null,simInterval=null;
let mathSolved=0,challengeIdx=0,totalChallenges=0;
let cars=[],phaseTime=0,signalPhase='green';
let phaseDurations={green:25,yellow:5,red:30};
let bPhase='red',bPhaseDurations={green:30,yellow:5,red:25},bPhaseTime=30;
let yieldAngle=60,rotorSpeed=4;
let showOverlay=true;
let waveTimer=0,currentWave=0;
let arrivalRates={N:8,S:6,E:7,W:5};
let roundaboutAngle=0;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• NAV â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function selectLevel(idx){
  currentLevel=idx;
  const lv=LEVELS[idx];
  if(lv.intType==='roundabout') currentInt='roundabout';
  document.getElementById('intersection-picker').style.display='block';
}
function selectInt(el,type){
  document.querySelectorAll('.int-card').forEach(c=>c.classList.remove('selected'));
  el.classList.add('selected'); currentInt=type;
}
function startGame(){
  document.getElementById('screen-title').style.display='none';
  const gs=document.getElementById('screen-game');
  gs.style.display='flex';
  initGame();
}
function goHome(){
  clearIntervals();
  document.getElementById('screen-game').style.display='none';
  document.getElementById('screen-title').style.display='flex';
  document.getElementById('intersection-picker').style.display='none';
  document.getElementById('overlay-complete').classList.remove('show');
}
function nextLevel(){
  document.getElementById('overlay-complete').classList.remove('show');
  if(currentLevel<5){currentLevel++;initGame();}else goHome();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• INIT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initGame(){
  const lv=LEVELS[currentLevel];
  score=0;flowPct=30;timer=lv.timer;mathSolved=0;challengeIdx=0;
  currentWave=0;waveTimer=0;totalChallenges=lv.mathChallenges.length;
  currentInt=lv.intType==='roundabout'?'roundabout':currentInt;

  document.getElementById('game-title').textContent=lv.title;
  document.getElementById('diff-label').textContent=lv.diffLabel;
  document.getElementById('diff-label').className='diff-badge '+lv.diffClass;
  document.getElementById('target-label').textContent='Target: '+lv.targetFlow+'%';
  document.getElementById('stat-score').textContent='0';
  document.getElementById('stat-flow').textContent='30%';
  document.getElementById('stat-timer').textContent=timer;
  document.getElementById('stat-math').textContent='0';

  document.getElementById('standard-controls').style.display=currentInt==='roundabout'?'none':'block';
  document.getElementById('roundabout-controls').style.display=currentInt==='roundabout'?'block':'none';
  document.getElementById('signal-b-row').style.display=lv.showB?'block':'none';

  arrivalRates={...lv.arrivalBase};
  updateArrivalDisplay();

  const bar=document.getElementById('flow-bar');
  bar.style.width='30%'; bar.style.background='var(--signal-red)';

  loadMathChallenge(); buildStepsBar();
  clearIntervals(); spawnCars();
  resizeCanvases();
  timerInterval=setInterval(tickTimer,1000);
  simInterval=setInterval(()=>{drawIntersection();drawMathOverlay();},50);

  // Re-resolve canvas size if layout shifts after a frame
  requestAnimationFrame(()=>{ resizeCanvases(); });
}
function clearIntervals(){
  if(timerInterval)clearInterval(timerInterval);
  if(simInterval)clearInterval(simInterval);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• WAVES â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateArrivalDisplay(){
  const lv=LEVELS[currentLevel];
  ['N','S','E','W'].forEach(d=>{
    const el=document.getElementById('arr-'+d);
    const scale=lv.difficultyScale[Math.min(currentWave,lv.difficultyScale.length-1)];
    arrivalRates[d]=Math.round(lv.arrivalBase[d]*scale);
    el.textContent=arrivalRates[d]+'/min';
    el.classList.toggle('hot',arrivalRates[d]>15);
  });
}
function advanceWave(){
  const lv=LEVELS[currentLevel];
  if(currentWave<lv.difficultyScale.length-1){
    currentWave++;
    updateArrivalDisplay();
    for(let i=0;i<4;i++) cars.push(makeCar(['N','S','E','W'][Math.floor(Math.random()*4)],Math.random()*60));
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TIMER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function tickTimer(){
  timer--;
  document.getElementById('stat-timer').textContent=timer;
  phaseTime++;
  if(signalPhase==='green'&&phaseTime>=phaseDurations.green){signalPhase='yellow';phaseTime=0;}
  else if(signalPhase==='yellow'&&phaseTime>=phaseDurations.yellow){signalPhase='red';phaseTime=0;}
  else if(signalPhase==='red'&&phaseTime>=phaseDurations.red){signalPhase='green';phaseTime=0;}
  bPhaseTime++;
  if(bPhase==='green'&&bPhaseTime>=bPhaseDurations.green){bPhase='yellow';bPhaseTime=0;}
  else if(bPhase==='yellow'&&bPhaseTime>=bPhaseDurations.yellow){bPhase='red';bPhaseTime=0;}
  else if(bPhase==='red'&&bPhaseTime>=bPhaseDurations.red){bPhase='green';bPhaseTime=0;}
  roundaboutAngle=(roundaboutAngle+rotorSpeed*0.03)%(Math.PI*2);
  waveTimer++;
  if(waveTimer%30===0) advanceWave();
  if(timer<=0) endLevel();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CARS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function spawnCars(){
  cars=[];
  const count=currentInt==='roundabout'?16:12;
  for(let i=0;i<count;i++){
    const dirs=currentInt==='T'?['N','E','W']:['N','S','E','W'];
    cars.push(makeCar(dirs[Math.floor(Math.random()*dirs.length)],i*30));
  }
}
function makeCar(dir,delay){
  const cx=220,cy=220;
  let x,y,vx=0,vy=0;
  if(dir==='N'){x=cx-6+Math.random()*12;y=455;vy=-2.2;}
  else if(dir==='S'){x=cx-6+Math.random()*12;y=-20;vy=2.2;}
  else if(dir==='E'){x=-20;y=cy-6+Math.random()*12;vx=2.2;}
  else{x=460;y=cy-6+Math.random()*12;vx=-2.2;}
  // Warm earthy car colors
  const hues=[20,35,50,180,200,260,320];
  const hue=hues[Math.floor(Math.random()*hues.length)];
  return{x,y,vx,vy,dir,delay,color:`hsl(${hue},55%,55%)`,roundAngle:Math.random()*Math.PI*2,inRound:false};
}
function respawnCar(c){
  const dirs=currentInt==='T'?['N','E','W']:['N','S','E','W'];
  Object.assign(c,makeCar(dirs[Math.floor(Math.random()*dirs.length)],50+Math.floor(Math.random()*70)));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• DPR-AWARE CANVAS RESIZE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Logical canvas size (coordinate space used by all draw code)
const CANVAS_W = 440, CANVAS_H = 440;

function setupCanvas(canvas) {
  const dpr = window.devicePixelRatio || 1;
  // Read the CSS display size we explicitly set in resizeCanvases
  const displayW = parseFloat(canvas.style.width)  || CANVAS_W;
  const displayH = parseFloat(canvas.style.height) || CANVAS_H;
  canvas.width  = Math.round(displayW * dpr);
  canvas.height = Math.round(displayH * dpr);
  const ctx = canvas.getContext('2d');
  // Scale so all draw code uses the logical CANVAS_W Ã— CANVAS_H coordinate space
  ctx.scale(dpr * displayW / CANVAS_W, dpr * displayH / CANVAS_H);
  return ctx;
}

function resizeCanvases() {
  const gameScreen = document.getElementById('screen-game');
  const header     = gameScreen ? gameScreen.querySelector('.game-header') : null;
  if (!gameScreen || !header) return;

  const cv  = document.getElementById('intersection-canvas');
  const oc  = document.getElementById('math-overlay-canvas');
  const frame = document.getElementById('canvas-frame');
  if (!cv || !oc || !frame) return;

  // Available vertical space = screen height - header - gap - arrival/flow strip - some padding
  const screenH    = gameScreen.clientHeight;
  const headerH    = header.offsetHeight;
  const bottomH    = 68; // arrival badges + flow meter
  const padding    = 18; // top/bottom padding + gaps
  const available  = screenH - headerH - bottomH - padding;

  // Square: use the smaller of available height vs (screen width - control panel - gap)
  const panelW  = 300; // control panel max width
  const gapPad  = 30;  // gap + screen padding
  const maxFromW = gameScreen.clientWidth - panelW - gapPad;
  const size    = Math.max(200, Math.min(available, maxFromW));

  // Set frame size
  frame.style.width  = size + 'px';
  frame.style.height = size + 'px';

  // Inner canvas = frame minus border (3px each side) minus padding (6px each side)
  const inner = size - 18;

  // Set CSS display size
  cv.style.width  = inner + 'px';
  cv.style.height = inner + 'px';
  oc.style.width  = inner + 'px';
  oc.style.height = inner + 'px';

  // Sync arrival display and flow meter to same width as frame
  const arrivalEl = document.getElementById('arrival-display');
  const flowEl    = document.querySelector('.flow-meter');
  if (arrivalEl) arrivalEl.style.width = size + 'px';
  if (flowEl)    flowEl.style.width    = size + 'px';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CANVAS DRAW â€” WARM WORLD â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function drawIntersection(){
  const cv=document.getElementById('intersection-canvas');
  const ctx=setupCanvas(cv);
  const W=CANVAS_W,H=CANVAS_H,cx=220,cy=220;
  ctx.clearRect(0,0,W,H);

  // Warm earthy ground
  const grd=ctx.createRadialGradient(cx,cy,40,cx,cy,280);
  grd.addColorStop(0,'#7a9a5a');
  grd.addColorStop(0.5,'#5a7a3a');
  grd.addColorStop(1,'#3a5a2a');
  ctx.fillStyle=grd; ctx.fillRect(0,0,W,H);

  // Grass texture dots
  ctx.fillStyle='rgba(60,100,30,0.3)';
  for(let i=0;i<80;i++){
    const gx=Math.sin(i*137.5)*200+220, gy=Math.cos(i*97.3)*200+220;
    if(Math.hypot(gx-cx,gy-cy)>90){ctx.beginPath();ctx.arc(gx,gy,1.5,0,Math.PI*2);ctx.fill();}
  }

  if(currentInt==='roundabout') drawRoundabout(ctx,W,H,cx,cy);
  else drawCobblestoneRoads(ctx,W,H,cx,cy);

  // Status bar â€” parchment strip at bottom
  ctx.fillStyle='rgba(200,175,100,0.82)';
  ctx.fillRect(0,H-22,W,22);
  ctx.strokeStyle='rgba(120,90,40,0.5)'; ctx.lineWidth=1;
  ctx.beginPath(); ctx.moveTo(0,H-22); ctx.lineTo(W,H-22); ctx.stroke();
  ctx.fillStyle=flowPct>=70?'#2e7d32':flowPct>=50?'#d4820a':'#c0392b';
  ctx.font='bold 10px "Crimson Text", Georgia, serif';
  ctx.textAlign='left';
  ctx.fillText(`Flow: ${flowPct}%   Phase: ${signalPhase}   Wave ${currentWave+1}   Time: ${timer}s`,8,H-8);
}

function drawCobblestoneRoads(ctx,W,H,cx,cy){
  const roadColor='#7a6e5e', roadDark='#5a5040';

  // Roads â€” cobblestone base
  ctx.fillStyle=roadColor;
  ctx.fillRect(cx-42,0,84,H);
  ctx.fillRect(0,cy-42,W,84);
  ctx.fillStyle='#6a5e4e';
  ctx.fillRect(cx-42,cy-42,84,84);

  // Cobble pattern (N/S road)
  drawCobbles(ctx,cx-42,0,84,cy-44);
  drawCobbles(ctx,cx-42,cy+44,84,H-cy-44);
  // Cobble pattern (E/W road)
  drawCobbles(ctx,0,cy-42,cx-44,84);
  drawCobbles(ctx,cx+44,cy-42,W-cx-44,84);

  // T-junction: fill south
  if(currentInt==='T'){
    ctx.fillStyle='#3a5a2a';
    const grad=ctx.createLinearGradient(cx-42,cy+44,cx+42,cy+44);
    grad.addColorStop(0,'#5a7a3a'); grad.addColorStop(1,'#3a5a2a');
    ctx.fillStyle=grad;
    ctx.fillRect(cx-42,cy+44,84,H-cy-44);
  }

  // Central lane markings â€” worn white paint
  ctx.setLineDash([14,12]);
  ctx.strokeStyle='rgba(240,220,160,0.6)'; ctx.lineWidth=2;
  ctx.beginPath(); ctx.moveTo(cx,0); ctx.lineTo(cx,cy-44); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(cx,cy+44); ctx.lineTo(cx,H-22); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(0,cy); ctx.lineTo(cx-44,cy); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(cx+44,cy); ctx.lineTo(W,cy); ctx.stroke();
  ctx.setLineDash([]);

  // Stop lines â€” thick worn paint
  ctx.strokeStyle='rgba(240,220,160,0.8)'; ctx.lineWidth=3;
  ctx.beginPath(); ctx.moveTo(cx-42,cy-48); ctx.lineTo(cx+42,cy-48); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(cx-42,cy+48); ctx.lineTo(cx+42,cy+48); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(cx-48,cy-42); ctx.lineTo(cx-48,cy+42); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(cx+48,cy-42); ctx.lineTo(cx+48,cy+42); ctx.stroke();

  // Wooden signal posts
  drawWoodenSignal(ctx, cx-62, cy-88, signalPhase, 'vert',  'â†‘â†“ N/S');
  drawWoodenSignal(ctx, cx+48, cy+48, signalPhase, 'vert',  'â†‘â†“ N/S');
  if(currentInt!=='T'){
    drawWoodenSignal(ctx, cx-88, cy-62, bPhase, 'horiz', 'â†â†’ E/W');
    drawWoodenSignal(ctx, cx+48, cy-62, bPhase, 'horiz', 'â†â†’ E/W');
  }

  // Cars
  const aGo=signalPhase==='green', bGo=bPhase==='green';
  for(const c of cars){
    c.delay--; if(c.delay>0) continue;
    const ns=c.dir==='N'||c.dir==='S';
    const go=ns?aGo:bGo;
    let blocked=false;
    if(!go){
      if(c.dir==='N'&&c.y>cy+50&&c.y<cy+130) blocked=true;
      if(c.dir==='S'&&c.y<cy-50&&c.y>cy-130) blocked=true;
      if(c.dir==='E'&&c.x<cx-50&&c.x>cx-130) blocked=true;
      if(c.dir==='W'&&c.x>cx+50&&c.x<cx+130) blocked=true;
    }
    if(!blocked){c.x+=c.vx*(1+flowPct/180);c.y+=c.vy*(1+flowPct/180);}
    if(c.x<-35||c.x>W+35||c.y<-35||c.y>H-14){respawnCar(c);continue;}
    drawCar(ctx,c.x,c.y,c.dir,c.color,ns);
  }
}

function drawCobbles(ctx,rx,ry,rw,rh){
  if(rw<=0||rh<=0) return;
  const cw=12, ch=8;
  ctx.save(); ctx.beginPath(); ctx.rect(rx,ry,rw,rh); ctx.clip();
  for(let row=ry;row<ry+rh+ch;row+=ch){
    for(let col=rx+(row%16===0?0:6);col<rx+rw+cw;col+=cw){
      const shade=Math.random()*0.12-0.06;
      ctx.fillStyle=`rgba(${100+shade*100},${90+shade*100},${75+shade*100},0.9)`;
      ctx.beginPath();
      ctx.roundRect(col+0.5,row+0.5,cw-1.5,ch-1.5,1);
      ctx.fill();
      ctx.strokeStyle='rgba(0,0,0,0.2)'; ctx.lineWidth=0.5;
      ctx.stroke();
    }
  }
  ctx.restore();
}

function drawCar(ctx,x,y,dir,color,ns){
  ctx.save();
  ctx.translate(x,y);
  if(!ns) ctx.rotate(Math.PI/2);
  // Car body
  ctx.fillStyle=color;
  ctx.shadowColor='rgba(0,0,0,0.4)'; ctx.shadowBlur=4; ctx.shadowOffsetY=2;
  ctx.beginPath(); ctx.roundRect(-5,-9,10,18,2); ctx.fill();
  ctx.shadowBlur=0; ctx.shadowOffsetY=0;
  // Windshield gleam
  ctx.fillStyle='rgba(255,255,255,0.35)';
  ctx.beginPath(); ctx.roundRect(-3,-7,6,5,1); ctx.fill();
  // Wheels
  ctx.fillStyle='rgba(0,0,0,0.6)';
  [[-5,-6],[-5,3],[5,-6],[5,3]].forEach(([wx,wy])=>{
    ctx.beginPath(); ctx.arc(wx,wy,2,0,Math.PI*2); ctx.fill();
  });
  ctx.restore();
}

function drawRoundabout(ctx,W,H,cx,cy){
  const R=95, inner=54;

  // Entry roads with cobbles
  drawCobbles(ctx,cx-22,0,44,cy-R+4);
  drawCobbles(ctx,cx-22,cy+R-4,44,H-cy-R+4);
  drawCobbles(ctx,0,cy-22,cx-R+4,44);
  drawCobbles(ctx,cx+R-4,cy-22,W-cx-R+4,44);

  // Roundabout road ring
  ctx.fillStyle='#7a6e5e';
  ctx.beginPath(); ctx.arc(cx,cy,R,0,Math.PI*2); ctx.fill();
  ctx.fillStyle='#5a7a3a';
  ctx.beginPath(); ctx.arc(cx,cy,inner,0,Math.PI*2); ctx.fill();
  // Grass centre
  const gCenter=ctx.createRadialGradient(cx-10,cy-10,5,cx,cy,inner);
  gCenter.addColorStop(0,'#8aba5a');
  gCenter.addColorStop(1,'#5a8a3a');
  ctx.fillStyle=gCenter;
  ctx.beginPath(); ctx.arc(cx,cy,inner,0,Math.PI*2); ctx.fill();
  // Small flower in centre
  ctx.fillStyle='#e8c840'; ctx.shadowColor='rgba(230,200,50,0.5)'; ctx.shadowBlur=6;
  ctx.beginPath(); ctx.arc(cx,cy,8,0,Math.PI*2); ctx.fill();
  ctx.shadowBlur=0;
  ctx.fillStyle='rgba(255,255,255,0.7)';
  for(let i=0;i<6;i++){
    const a=i*Math.PI/3+roundaboutAngle;
    ctx.beginPath(); ctx.arc(cx+Math.cos(a)*8,cy+Math.sin(a)*8,3,0,Math.PI*2); ctx.fill();
  }

  // Lane marking circle
  ctx.setLineDash([10,9]); ctx.strokeStyle='rgba(240,220,160,0.5)'; ctx.lineWidth=1.5;
  ctx.beginPath(); ctx.arc(cx,cy,(R+inner)/2,0,Math.PI*2); ctx.stroke();
  ctx.setLineDash([]);

  // Yield markers
  for(let i=0;i<4;i++){
    const a=roundaboutAngle+(i/4)*Math.PI*2;
    const mx=cx+Math.cos(a)*(R-10), my=cy+Math.sin(a)*(R-10);
    const col=yieldAngle>90?'#2e7d32':'#d4820a';
    ctx.fillStyle=col; ctx.shadowColor=col; ctx.shadowBlur=8;
    ctx.beginPath(); ctx.arc(mx,my,5,0,Math.PI*2); ctx.fill();
    ctx.shadowBlur=0;
  }

  // Entry direction arrows
  [{x:cx,y:cy-R-18,dx:0,dy:-1},{x:cx,y:cy+R+18,dx:0,dy:1},{x:cx-R-18,y:cy,dx:-1,dy:0},{x:cx+R+18,y:cy,dx:1,dy:0}]
    .forEach(({x,y,dx,dy})=>drawArrow(ctx,x,y,dx,dy,'rgba(240,220,160,0.7)'));

  // Cars
  for(const c of cars){
    c.delay--; if(c.delay>0) continue;
    if(!c.inRound){
      c.x+=c.vx*(1+flowPct/200); c.y+=c.vy*(1+flowPct/200);
      const dist=Math.hypot(c.x-cx,c.y-cy);
      if(dist<R+8&&dist>inner+4){c.inRound=true;c.roundAngle=Math.atan2(c.y-cy,c.x-cx);}
    } else {
      const sp=(0.018+flowPct*0.0003)*rotorSpeed/4;
      c.roundAngle+=sp;
      c.x=cx+Math.cos(c.roundAngle)*(R-22); c.y=cy+Math.sin(c.roundAngle)*(R-22);
      if(Math.random()<0.004+(flowPct/4000)){c.inRound=false;Object.assign(c,makeCar(['N','S','E','W'][Math.floor(Math.random()*4)],0));}
    }
    if(c.x<-35||c.x>W+35||c.y<-35||c.y>H+35){respawnCar(c);continue;}
    ctx.save(); ctx.translate(c.x,c.y);
    if(c.inRound) ctx.rotate(c.roundAngle+Math.PI/2);
    else if(c.dir==='N'||c.dir==='S') ctx.rotate(c.vy>0?Math.PI:0);
    else ctx.rotate(c.vx>0?Math.PI/2:-Math.PI/2);
    ctx.fillStyle=c.color; ctx.shadowColor='rgba(0,0,0,0.4)'; ctx.shadowBlur=4; ctx.shadowOffsetY=2;
    ctx.beginPath(); ctx.roundRect(-5,-9,10,18,2); ctx.fill();
    ctx.shadowBlur=0; ctx.shadowOffsetY=0;
    ctx.fillStyle='rgba(255,255,255,0.35)';
    ctx.beginPath(); ctx.roundRect(-3,-7,6,5,1); ctx.fill();
    ctx.restore();
  }
}

function drawArrow(ctx,x,y,dx,dy,color){
  ctx.fillStyle=color; ctx.globalAlpha=0.8;
  ctx.beginPath();
  ctx.moveTo(x,y);
  ctx.lineTo(x-dy*7+dx*7,y+dx*7+dy*7);
  ctx.lineTo(x+dy*7+dx*7,y-dx*7+dy*7);
  ctx.closePath(); ctx.fill(); ctx.globalAlpha=1;
}

function drawWoodenSignal(ctx, x, y, phase, orient, label=''){
  const w = orient==='vert' ? 18 : 46;
  const h = orient==='vert' ? 46 : 18;

  // Wooden post
  ctx.fillStyle='#6b4423';
  if(orient==='vert')  ctx.fillRect(x+7, y+h,   3, 22);
  else                 ctx.fillRect(x+w, y+6,   22,  3);

  // Wood housing gradient
  const grad = ctx.createLinearGradient(x, y, x+w, y+h);
  grad.addColorStop(0, '#8a5535');
  grad.addColorStop(1, '#4a2810');
  ctx.fillStyle = grad;
  ctx.beginPath(); ctx.roundRect(x, y, w, h, 3); ctx.fill();
  ctx.strokeStyle='rgba(0,0,0,0.45)'; ctx.lineWidth=1;
  ctx.beginPath(); ctx.roundRect(x, y, w, h, 3); ctx.stroke();
  // Highlight strip
  ctx.fillStyle='rgba(255,255,255,0.08)';
  ctx.beginPath(); ctx.roundRect(x+1, y+1, w-2, 4, 2); ctx.fill();

  const cols  = ['#c0392b','#d4820a','#2e7d32'];
  const glows = ['rgba(192,57,43,0.75)','rgba(212,130,10,0.75)','rgba(46,125,50,0.75)'];
  const pos   = orient==='vert'
    ? [[x+4,y+4],[x+4,y+17],[x+4,y+30]]
    : [[x+4,y+4],[x+17,y+4],[x+30,y+4]];
  const active = phase==='red'?0:phase==='yellow'?1:2;

  for(let i=0;i<3;i++){
    if(i===active){
      ctx.fillStyle=glows[i]; ctx.shadowColor=cols[i]; ctx.shadowBlur=14;
      ctx.beginPath(); ctx.arc(pos[i][0]+5,pos[i][1]+5,6.5,0,Math.PI*2); ctx.fill();
      ctx.shadowBlur=0;
      ctx.fillStyle=cols[i]; ctx.shadowColor=cols[i]; ctx.shadowBlur=7;
      ctx.beginPath(); ctx.arc(pos[i][0]+5,pos[i][1]+5,5,0,Math.PI*2); ctx.fill();
      ctx.shadowBlur=0;
    } else {
      ctx.fillStyle='rgba(0,0,0,0.75)';
      ctx.beginPath(); ctx.arc(pos[i][0]+5,pos[i][1]+5,4,0,Math.PI*2); ctx.fill();
    }
  }

  // â”€â”€ Direction label tag â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if(!label) return;
  ctx.save();

  // Tag dimensions
  const tagW = 38, tagH = 13;
  let tx, ty;
  if(orient==='vert'){
    // Hang below the post
    tx = x + w/2 - tagW/2;
    ty = y + h + 22 + 2;
  } else {
    // Hang below the housing (post goes right, so tag goes below housing)
    tx = x - 2;
    ty = y + h + 4;
  }

  // Tag parchment background
  const tg = ctx.createLinearGradient(tx, ty, tx, ty+tagH);
  tg.addColorStop(0, 'rgba(252,243,215,0.97)');
  tg.addColorStop(1, 'rgba(228,208,158,0.95)');
  ctx.fillStyle = tg;
  ctx.beginPath(); ctx.roundRect(tx, ty, tagW, tagH, 2); ctx.fill();
  ctx.strokeStyle='rgba(107,68,35,0.55)'; ctx.lineWidth=0.8;
  ctx.beginPath(); ctx.roundRect(tx, ty, tagW, tagH, 2); ctx.stroke();

  // Label text
  ctx.fillStyle = '#3d1f08';
  ctx.font = 'bold 8px Georgia, serif';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillText(label, tx + tagW/2, ty + tagH/2 + 0.5);

  ctx.restore();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MATH OVERLAY (PARCHMENT STYLE) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleOverlay(){ showOverlay=document.getElementById('overlay-toggle').checked; }

function drawMathOverlay(){
  const oc=document.getElementById('math-overlay-canvas');
  const ctx=setupCanvas(oc);
  ctx.clearRect(0,0,CANVAS_W,CANVAS_H);
  if(!showOverlay) return;
  const lv=LEVELS[currentLevel];
  const ch=lv.mathChallenges[challengeIdx%lv.mathChallenges.length];
  if(!ch||!ch.overlay) return;
  const ov=ch.overlay;

  // Parchment scroll overlay panel â€” taller for bigger fonts
  const bh=ov.type==='matrix'?140:ov.type==='eigen'?130:115;
  const bx=8,by=22,bw=CANVAS_W-16;
  // Shadow
  ctx.fillStyle='rgba(0,0,0,0.35)';
  roundRF(ctx,bx+3,by+3,bw,bh,6); ctx.fill();
  // Parchment bg
  const pg=ctx.createLinearGradient(bx,by,bx,by+bh);
  pg.addColorStop(0,'rgba(252,245,222,0.97)');
  pg.addColorStop(1,'rgba(235,215,168,0.95)');
  ctx.fillStyle=pg; roundRF(ctx,bx,by,bw,bh,6); ctx.fill();
  // Border
  ctx.strokeStyle='rgba(107,68,35,0.65)'; ctx.lineWidth=1.5;
  roundRS(ctx,bx,by,bw,bh,6); ctx.stroke();
  // Inner decorative line
  ctx.strokeStyle='rgba(160,130,80,0.3)'; ctx.lineWidth=0.8;
  roundRS(ctx,bx+5,by+5,bw-10,bh-10,4); ctx.stroke();

  ctx.globalAlpha=1;
  if(ov.type==='linear')  drawLinOv(ctx,ov,bx+14,by+18,bw-28);
  else if(ov.type==='system') drawSysOv(ctx,ov,bx+14,by+18,bw-28);
  else if(ov.type==='matrix') drawMatOv(ctx,ov,bx+14,by+14,bw-28);
  else if(ov.type==='vector') drawVecOv(ctx,ov,bx+14,by+18,bw-28);
  else if(ov.type==='eigen')  drawEigOv(ctx,ov,bx+14,by+14,bw-28);
  else if(ov.type==='rotor')  drawRotOv(ctx,ov,bx+14,by+18,bw-28);
}

function roundRF(ctx,x,y,w,h,r){ctx.beginPath();ctx.moveTo(x+r,y);ctx.lineTo(x+w-r,y);ctx.arcTo(x+w,y,x+w,y+r,r);ctx.lineTo(x+w,y+h-r);ctx.arcTo(x+w,y+h,x+w-r,y+h,r);ctx.lineTo(x+r,y+h);ctx.arcTo(x,y+h,x,y+h-r,r);ctx.lineTo(x,y+r);ctx.arcTo(x,y,x+r,y,r);ctx.closePath();}
function roundRS(ctx,x,y,w,h,r){roundRF(ctx,x,y,w,h,r);ctx.stroke();}

function drawLinOv(ctx,ov,x,y,w){
  ctx.fillStyle='#4a2808'; ctx.font='bold 15px Georgia,serif'; ctx.fillText('Linear Equation',x,y);
  ctx.fillStyle='#3d2010'; ctx.font='italic 17px Georgia,serif'; ctx.fillText(ov.eq,x,y+22);
  ctx.font='13px Georgia,serif'; ctx.fillStyle='#7a6050';
  const vals=Object.entries(ov.vars).map(([k,v])=>`${k} = ${v}`).join('     ');
  ctx.fillText(vals,x,y+42);
  let bx2=x;
  Object.entries(ov.vars).forEach(([k,v],i)=>{
    const norm=Math.min(v/100,1);
    ctx.fillStyle=['#c0392b','#2e7d32','#d4820a','#6b4423'][i%4];
    ctx.globalAlpha=0.65; ctx.fillRect(bx2,y+52,50*norm,8); ctx.globalAlpha=1;
    ctx.fillStyle='#7a6050'; ctx.font='11px Georgia,serif'; ctx.fillText(k,bx2,y+74);
    bx2+=65;
  });
}

function drawSysOv(ctx,ov,x,y,w){
  ctx.fillStyle='#4a2808'; ctx.font='bold 15px Georgia,serif'; ctx.fillText('System of Equations',x,y);
  ov.eqs.forEach((eq,i)=>{
    ctx.fillStyle=i===0?'#2e7d32':'#c07010'; ctx.font='italic 16px Georgia,serif';
    ctx.fillText(`[${i+1}]  ${eq}`,x,y+22+i*22);
  });
  ctx.fillStyle='#5a4030'; ctx.font='13px Georgia,serif';
  ctx.fillText(`â†’ Add equations to eliminate variable, solve for: ${ov.highlight}`,x,y+70);
}

function drawMatOv(ctx,ov,x,y,w){
  ctx.fillStyle='#4a2808'; ctx.font='bold 15px Georgia,serif'; ctx.fillText('Matrix Â· Vector',x,y);
  const M=ov.M, d=ov.d;
  ctx.font='14px Georgia,serif';
  ctx.fillStyle='#3d2010'; ctx.fillText('M =',x,y+24);
  M.forEach((row,i)=>{
    ctx.fillStyle=i===ov.highlight?'#2e7d32':'#7a6050';
    ctx.fillText(`[ ${row.join(', ')} ]`,x+48,y+24+i*20);
  });
  ctx.fillStyle='#3d2010'; ctx.fillText('d =',x+200,y+24);
  d.forEach((v,i)=>{ctx.fillStyle='#c07010'; ctx.fillText('[ '+v+' ]',x+232,y+24+i*20);});
  ctx.fillStyle='#2e7d32'; ctx.font='12px Georgia,serif';
  ctx.fillText(`rowâ‚Â·d = ${M[0][0]}Ã—${d[0]} + ${M[0][1]}Ã—${d[1]} = ${M[0][0]*d[0]+M[0][1]*d[1]}`,x,y+74);
  ctx.fillStyle='#7a6050';
  ctx.fillText(`rowâ‚‚Â·d = ${M[1][0]}Ã—${d[0]} + ${M[1][1]}Ã—${d[1]} = ${M[1][0]*d[0]+M[1][1]*d[1]}`,x,y+92);
}

function drawVecOv(ctx,ov,x,y,w){
  ctx.fillStyle='#4a2808'; ctx.font='bold 15px Georgia,serif'; ctx.fillText('Vector Operation: '+ov.op,x,y);
  ctx.fillStyle='#2e7d32'; ctx.font='14px Georgia,serif'; ctx.fillText(`a = [${ov.v1.join(', ')}]`,x,y+22);
  if(ov.v2){ctx.fillStyle='#c07010'; ctx.fillText(`b = [${ov.v2.join(', ')}]`,x+180,y+22);}
  ctx.fillStyle='#5a4030'; ctx.font='12px Georgia,serif';
  if(ov.op==='dot') ctx.fillText(`aÂ·b = ${ov.v1[0]}Ã—${ov.v2[0]} + ${ov.v1[1]}Ã—${ov.v2[1]} = ${ov.v1[0]*ov.v2[0]+ov.v1[1]*ov.v2[1]}`,x,y+44);
  else if(ov.op==='magnitude') ctx.fillText(`|a+b| = âˆš( (${ov.v1[0]}+${ov.v2[0]})Â² + (${ov.v1[1]}+${ov.v2[1]})Â² )`,x,y+44);
  else if(ov.op==='unit'){const m=Math.hypot(...ov.v1);ctx.fillText(`|v| = ${m.toFixed(1)}   vÌ‚ = [${(ov.v1[0]/m).toFixed(2)}, ${(ov.v1[1]/m).toFixed(2)}]`,x,y+44);}
  // Mini vector arrows
  const ox=x+w-90, oy=y+38;
  [[ov.v1,'#2e7d32'],[ov.v2,'#c07010']].forEach(([v,col])=>{
    if(!v) return;
    const sc=4.5;
    ctx.strokeStyle=col; ctx.lineWidth=2; ctx.fillStyle=col;
    ctx.beginPath(); ctx.moveTo(ox,oy); ctx.lineTo(ox+v[0]*sc,oy-v[1]*sc); ctx.stroke();
    ctx.beginPath(); ctx.arc(ox+v[0]*sc,oy-v[1]*sc,3,0,Math.PI*2); ctx.fill();
  });
}

function drawEigOv(ctx,ov,x,y,w){
  ctx.fillStyle='#4a2808'; ctx.font='bold 15px Georgia,serif'; ctx.fillText('Eigenvalue Analysis',x,y);
  const A=ov.A;
  ctx.fillStyle='#7a6050'; ctx.font='13px Georgia,serif';
  ctx.fillText(`A = [[${A[0].join(',')}],[${A[1].join(',')}]]`,x,y+22);
  ctx.fillStyle='#3d2010'; ctx.fillText('det(A âˆ’ Î»I) = 0',x,y+42);
  if(ov.eigenvals){ctx.fillStyle='#2e7d32'; ctx.fillText(`Î»â‚ = ${ov.eigenvals[0]}   Î»â‚‚ = ${ov.eigenvals[1]}`,x,y+62);}
  if(ov.steadyState){ctx.fillStyle='#c07010'; ctx.fillText(`Steady state Ï€ = [${ov.steadyState.join(', ')}]`,x,y+82);}
}

function drawRotOv(ctx,ov,x,y,w){
  ctx.fillStyle='#4a2808'; ctx.font='bold 15px Georgia,serif'; ctx.fillText('Geometric Algebra â€” Rotor',x,y);
  ctx.fillStyle='#3d2010'; ctx.font='13px Georgia,serif';
  ctx.fillText('R = cos(Î¸/2) + sin(Î¸/2)Â·eâ‚â‚‚',x,y+22);
  if(ov.op==='cos_half'){
    ctx.fillStyle='#7a6050'; ctx.fillText(`Î¸ = ${ov.theta}Â°  â†’  Î¸/2 = ${ov.theta/2}Â°`,x,y+42);
    ctx.fillStyle='#2e7d32'; ctx.fillText(`cos(${ov.theta/2}Â°) = ${Math.cos(ov.theta/2*Math.PI/180).toFixed(4)}`,x,y+62);
  } else if(ov.op==='sandwich'){
    ctx.fillStyle='#7a6050'; ctx.fillText(`Î±=${ov.alpha}Â°, Î¸=${ov.theta}Â°  â†’  exit = ${ov.alpha+ov.theta}Â°`,x,y+42);
    ctx.fillStyle='#2e7d32'; ctx.fillText(`sin(${ov.alpha+ov.theta}Â°) = ${Math.sin((ov.alpha+ov.theta)*Math.PI/180).toFixed(4)}`,x,y+62);
  } else if(ov.op==='capacity'){
    ctx.fillStyle='#7a6050'; ctx.fillText(`C = ${ov.omega} Ã— ${ov.r}Â² Ã— Ï€`,x,y+42);
    ctx.fillStyle='#2e7d32'; ctx.fillText(`= ${(ov.omega*ov.r*ov.r*Math.PI).toFixed(0)} cars/hr`,x,y+62);
    // Rotor arc
    const ocx=x+w-45, ocy=y+42;
    ctx.strokeStyle='#6b4423'; ctx.lineWidth=2.5;
    ctx.beginPath(); ctx.arc(ocx,ocy,22,0,roundaboutAngle); ctx.stroke();
    ctx.fillStyle='#6b4423'; ctx.shadowColor='rgba(107,68,35,0.6)'; ctx.shadowBlur=5;
    ctx.beginPath(); ctx.arc(ocx+Math.cos(roundaboutAngle)*22,ocy+Math.sin(roundaboutAngle)*22,4,0,Math.PI*2); ctx.fill();
    ctx.shadowBlur=0;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MATH PANEL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildStepsBar(){
  const bar=document.getElementById('steps-bar');
  bar.innerHTML='';
  LEVELS[currentLevel].mathChallenges.forEach((_,i)=>{
    const d=document.createElement('div');
    d.className='step-pip'+(i<challengeIdx?' done':i===challengeIdx?' current':'');
    bar.appendChild(d);
  });
}

function loadMathChallenge(){
  const lv=LEVELS[currentLevel];
  const ch=lv.mathChallenges[challengeIdx%lv.mathChallenges.length];
  document.getElementById('math-q').innerHTML=ch.q;
  document.getElementById('math-hint').textContent=ch.hint;
  document.getElementById('math-answer').value='';
  document.getElementById('math-topic').textContent=lv.topic;
  document.getElementById('feedback').style.display='none';
  buildStepsBar();
}

function checkMath(){
  const lv=LEVELS[currentLevel];
  const ch=lv.mathChallenges[challengeIdx%lv.mathChallenges.length];
  const ans=parseFloat(document.getElementById('math-answer').value);
  const fb=document.getElementById('feedback');
  fb.style.display='block';
  if(isNaN(ans)){fb.className='feedback wrong';fb.textContent='Please enter a number.';return;}
  if(Math.abs(ans-ch.answer)<=ch.tolerance){
    const pts=60+currentLevel*30;
    fb.className='feedback correct';
    fb.textContent=`âœ“ Well done! +${pts} coin â€” now apply this to your signals!`;
    score+=pts; mathSolved++;
    document.getElementById('stat-score').textContent=score;
    document.getElementById('stat-math').textContent=mathSolved;
    challengeIdx++; buildStepsBar();
    setTimeout(loadMathChallenge,2200);
  } else {
    fb.className='feedback wrong';
    fb.textContent=`âœ— Answer was ${ans}, expected ~${ch.answer}. Read the hint!`;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TIMING â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateYieldDisplay(){
  yieldAngle=parseInt(document.getElementById('yield-angle').value);
  rotorSpeed=parseInt(document.getElementById('rotor-speed').value);
  document.getElementById('yield-val').textContent=`Î¸ = ${yieldAngle}Â°`;
  document.getElementById('rotor-val').textContent=`Ï‰ = ${rotorSpeed} rad/s`;
}

function applyTiming(){
  const lv=LEVELS[currentLevel];
  let ratio;
  if(currentInt==='roundabout'){
    const angleDist=Math.abs(yieldAngle-60);
    const angleScore=Math.max(0,1-(angleDist/80));
    const speedScore=Math.min(rotorSpeed/8,1);
    ratio=angleScore*0.6+speedScore*0.4;
  } else {
    const aR=parseInt(document.getElementById('a-red').value)||30;
    const aY=parseInt(document.getElementById('a-yellow').value)||5;
    const aG=parseInt(document.getElementById('a-green').value)||25;
    const bR=parseInt(document.getElementById('b-red').value)||25;
    const bY=parseInt(document.getElementById('b-yellow').value)||5;
    const bG=parseInt(document.getElementById('b-green').value)||30;
    phaseDurations={red:aR,yellow:aY,green:aG};
    bPhaseDurations={red:bR,yellow:bY,green:bG};
    const cA=aR+aY+aG, cB=bR+bY+bG;
    const rA=aG/cA, rB=bG/cB;
    const arrN=arrivalRates.N+arrivalRates.S, arrE=arrivalRates.E+arrivalRates.W;
    const total=arrN+arrE;
    const idealA=arrN/total, idealB=arrE/total;
    ratio=1-(Math.abs(rA-idealA)+Math.abs(rB-idealB))/2;
  }
  const wavePenalty=currentWave*5;
  const mathBonus=mathSolved*8;
  const newFlow=Math.min(97,Math.max(20,Math.round(25+ratio*75+mathBonus-wavePenalty)));
  const delta=newFlow-flowPct;
  flowPct=newFlow;

  const bar=document.getElementById('flow-bar');
  bar.style.width=flowPct+'%';
  bar.style.background=flowPct>=70?'var(--signal-green)':flowPct>=50?'var(--signal-amber)':'var(--signal-red)';
  document.getElementById('stat-flow').textContent=flowPct+'%';
  if(delta>0){score+=delta*12;document.getElementById('stat-score').textContent=score;}
  if(flowPct>=lv.targetFlow) setTimeout(showComplete,800);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• END â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showComplete(){
  clearIntervals();
  const stars=flowPct>=90?'â­â­â­':flowPct>=80?'â­â­':'â­';
  document.getElementById('overlay-stars').textContent=stars;
  document.getElementById('overlay-title').textContent='The Flow is Restored!';
  document.getElementById('overlay-msg').innerHTML=`
    Flow: <strong>${flowPct}%</strong> &ensp;Â·&ensp; Coin: <strong>${score}</strong><br>
    Challenges solved: <strong>${mathSolved}/${totalChallenges}</strong> &ensp;Â·&ensp; Wave: <strong>${currentWave+1}</strong><br><br>
    <em style="color:var(--ink-faded)">${LEVELS[currentLevel].topic} mastery recorded in the guild ledger.</em>
  `;
  document.getElementById('overlay-complete').classList.add('show');
}

function endLevel(){
  clearIntervals();
  const lv=LEVELS[currentLevel];
  const passed=flowPct>=lv.targetFlow;
  const stars=passed?(flowPct>=90?'â­â­â­':'â­â­'):'â­';
  document.getElementById('overlay-stars').textContent=stars;
  document.getElementById('overlay-title').textContent=passed?'Chapter Complete!':'The Flow Runs Dryâ€¦';
  document.getElementById('overlay-msg').innerHTML=`
    Flow: <strong>${flowPct}%</strong> (target: ${lv.targetFlow}%)<br>
    Coin: <strong>${score}</strong> &ensp;Â·&ensp; Math: <strong>${mathSolved}/${totalChallenges}</strong>
  `;
  document.getElementById('overlay-complete').classList.add('show');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• RESPONSIVE CANVAS RESIZE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('resize', resizeCanvases);
window.addEventListener('load',   resizeCanvases);

// Also handle devicePixelRatio changes (zoom, moving between monitors)
window.matchMedia(`(resolution: ${window.devicePixelRatio}dppx)`)
  .addEventListener('change', () => { resizeCanvases(); });

// polyfill
if(!CanvasRenderingContext2D.prototype.roundRect){
  CanvasRenderingContext2D.prototype.roundRect=function(x,y,w,h,r){
    this.beginPath();this.moveTo(x+r,y);this.lineTo(x+w-r,y);this.arcTo(x+w,y,x+w,y+r,r);
    this.lineTo(x+w,y+h-r);this.arcTo(x+w,y+h,x+w-r,y+h,r);this.lineTo(x+r,y+h);
    this.arcTo(x,y+h,x,y+h-r,r);this.lineTo(x,y+r);this.arcTo(x,y,x+r,y,r);this.closePath();return this;
  };
}
</script>
</body>
</html>
